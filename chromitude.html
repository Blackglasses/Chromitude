<!DOCTYPE html>
<script src="/oauth2/oauth2.js"></script>
<script src="settings.js"></script>
<script src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=true"></script>
<script>

var googleAuth = new OAuth2('google',{
	client_id: settings.consumer_key,
	client_secret: settings.consumer_secret,
	api_scope: 'https://www.googleapis.com/auth/latitude.current.best'
});

var clientSettings = new function() {
	this.get = function(setting)
	{
		return localStorage[setting];
	}
	this.put = function(setting,value,ifnotexists)
	{
		if(!(ifnotexists && this.exists(setting)))
			localStorage[setting] = value;
		return localStorage[setting];
	}
	this.exists = function(setting)
	{
		if(localStorage[setting] == undefined) return false;
		else return true;
	}
	// Defaults
	this.put("state","on",true);
	this.put("watch_location","on",true);
	this.put("only_update_when_active","on",true);
	this.put("use_checkins","on",true);
	this.put("show_notification","off",true);
	this.put("has_shown_donate","false",true);
	this.put("use_fixed_location","off",true);
	this.put("has_alerted_v2","false",true);
	this.put("use_highest_accuracy","on",true);
};

googleAuth.authorize(runSetup);

function runSetup()
{
	if(document.updateWatch) navigator.geolocation.clearWatch(document.updateWatch);

	if(clientSettings.get("use_fixed_location") == "on")
	{	
		if(clientSettings.get("state") == "on")
		{
			var location = JSON.parse(clientSettings.get("fixed_location"));
			location.timestamp = Math.floor(+new Date);
			location.accuracy = 10;
			document.lastPosition = location;
			updatePosition(location);
		}
		return;
	};
	
	if(clientSettings.get("use_highest_accuracy") == "on") highAccuracy = true;
	else highAccuracy = false;
	
	document.updateWatch = navigator.geolocation.watchPosition(function(pos)
	{
		// If we're not on
		if(!(clientSettings.get("state") == "on"))
		{
			document.lastPosition = undefined;
		}
		
		// If for some reason its the same as the last one, exit out of the function
		if(pos == document.lastPosition) return;
		document.lastPosition = pos;
		
		// Update the Position
		updatePosition(pos,function(response)
		{
			
		});
		
	},function() { }, { enableHighAccuracy: highAccuracy });
}

function updatePosition(pos,success)
{
	var location =
	{
		"data":
		{
			"kind": "latitude#location",
			"timestampMs": pos.timestamp,
			"latitude": pos.coords.latitude,
			"longitude": pos.coords.longitude,
			"accuracy": pos.coords.accuracy,
			"speed": pos.coords.speed,
			"altitude": pos.coords.altitude,
			"altitudeAccuracy": pos.coords.altitudeAccuracy
		}
	};
	
	xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function()
	{
		if(xhr.readyState == 4 && xhr.status == 200) success(JSON.parse(xhr.responseText));
	};
	xhr.open('POST','https://www.googleapis.com/latitude/v1/currentLocation?sensor=true&key=' + settings.simple_key + '&oauth_token=' + googleAuth.getAccessToken());
	xhr.setRequestHeader('Authorization', 'OAuth ' + googleAuth.getAccessToken());
	xhr.setRequestHeader('Content-Type', 'application/json');
	xhr.send(JSON.stringify(location));
}

</script>